---
title: "Covid-open-data"
author: "David Henderson"
date: "06/06/2020"
output: 
  html_document:
    theme: journal
    highlight: haddock
    df_print: paged
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.width = 12, fig.height = 9)
```

# Introduction

## Packages

```{r, warning=FALSE, message=FALSE}
library(tidyverse)
#Get most up-to-date version of opendatascot
#remotes::install_github("datasciencescotland/opendatascot", force = TRUE)
library(janitor)
library(lubridate)
library(opendatascot) 
library(here)
library(curl)
#library(phsmethods)   #remotes::install.github("Health-SocialCare-Scotland/phsmethods")

`%nin%` <- negate(`%in%`)

theme_set(theme_minimal(base_family = "Roboto", base_size = 20) +
            theme(panel.grid.minor = element_blank(),
                  axis.title.y = element_text(margin = margin(0, 20, 0, 0)),
                  axis.title.x = element_text(margin = margin(20, 0, 0, 0)),
                  plot.caption = element_text(colour = "#AAAAAA"),
                  plot.margin = margin(3,15,3,3,"mm")))
           

colour_palette <- c("#011f4b", "#03396c", "#005b96", "#6497b1", "#b3cde0")

colours_davidhen <- c("#e53935", "#3949ab", "#8e24aa", "#039be5",
                      "#00897b", "#7cb342", "#fdd835", "#fb8c00",
                      "#6d4c41", "#546e7a")

options(scipen = 10)
```

## Data

### Main data

Scrape deaths dataset - note I am selecting Scotland only here - it is possible to split by LA or Health Board...


```{r, warning=FALSE, message=FALSE}
#Download data via API
cv_data_main <- 
ods_dataset("deaths-involving-coronavirus-covid-19",
                            #return only national data
                           geography = "sc") %>% 
  select(-refArea, -measureType) %>% 
  clean_names() %>% 
  mutate(cause_of_death = str_replace(
           cause_of_death,
           "all-causes-average-of-corresponding-week-over-previous-5-years",
           "all-cause_5yr_average"),
         cause_of_death = factor(cause_of_death),  
         age = factor(age, levels = c("all", "0-years", "1-14-years", "15-44-years",
                                      "45-64-years", "65-74-years", "75-84-years",
                                      "85-years-and-over")),
         value = as.integer(value)) 
cv_data_main
```

```{r, eval=FALSE}
#Save data for report
feather::write_feather(cv_data_main, "derived_data/cv_data_main.feather")
```

### Weekly

```{r}
# Create a look-up table for week numbers to dates
week_lookup <- tibble(
  week_number = 1:52,
  week_date = seq(ymd(20191230), ymd(20201221), by = "1 week"))

cv_data_main %>% 
  filter(ref_period != "2020") %>% 
  rename(week_number = ref_period) %>% 
  mutate(week_number = str_replace(week_number, "2020-", ""),
         week_number = as.integer(week_number)) %>% 
  left_join(., week_lookup) %>% 
  select(week_date, week_number, everything()) -> cv_data_weekly
cv_data_weekly
```

```{r, eval=FALSE}
#Save data for report
feather::write_feather(cv_data_weekly, "derived_data/cv_data_weekly.feather")
```


### Management info

There is a lot of information in this extract. I am filtering to just include delayed discharges and care home information for Scotland as a whole. You can see all the available info with the `ods_structure("coronavirus-covid-19-management-information")` command. 


```{r}
cv_data_manage <- 
  ods_dataset("coronavirus-covid-19-management-information",
                              variable = 
                                c("delayed-discharges",
      "adult-care-homes-cumulative-number-that-have-reported-a-suspected-covid-19-case",
      "adult-care-homes-proportion-that-have-reported-a-suspected-covid-19-case",
      "adult-care-homes-cumulative-number-that-have-reported-more-than-one-suspected-covid-19-case",
      "adult-care-homes-number-with-current-suspected-covid-19-cases",
      "adult-care-homes-proportion-with-current-suspected-covid-19-cases",
      "adult-care-homes-cumulative-number-of-suspected-covid-19-cases",
      "adult-care-homes-daily-number-of-new-suspected-covid-19-cases",
      "adult-care-homes-number-of-staff-reported-as-absent",
      "adult-care-homes-adult-care-homes-which-submitted-a-return",
      "adult-care-homes-response-rate",
      "adult-care-homes-total-number-of-staff-in-adult-care-homes-which-submitted-a-return",
      "adult-care-homes-staff-absence-rate"),
      geography = "sc") %>% 
  select(-refArea) %>% 
  clean_names() %>% 
  rename(date = ref_period) %>% 
  mutate(date = ymd(date))
cv_data_manage
```

```{r, eval=FALSE}
#Save data for report
feather::write_feather(cv_data_manage, "derived_data/cv_data_manage.feather")
```


### Population estimates

API is not good for population data - it keeps on timing out on me plus most recent figures are for 2014. 
The NHS Scotland open data file is also very large so will read in with `fread()` directly from url.

```{r}
#pop_est_raw <- data.table::fread("https://www.opendata.nhs.scot/dataset/7f010430-6ce1-4813-b25c-f7f335bdc4dc/resource/c505f490-c201-44bd-abd1-1bd7a64285ee/download/dz2011-pop-est_30082019.csv") %>% 
#  clean_names %>% 
#  filter(year == "2018") %>% 
#  select(-year)

#feather::write_feather(pop_est_raw, "derived_data/pop_est_raw.feather")
pop_est_raw <- feather::read_feather("derived_data/pop_est_raw.feather")


pop_est_raw %>% 
  mutate(`0-years` = rowSums(pop_est_raw[,c(5)]),
         `1-14-years` = rowSums(pop_est_raw[,c(15:19)]),
         `15-44-years` = rowSums(pop_est_raw[,c(20:49)]),
         `45-64-years` = rowSums(pop_est_raw[,c(50:69)]),
         `65-74-years` = rowSums(pop_est_raw[,c(70:79)]),
         `75-84-years` = rowSums(pop_est_raw[,c(80:89)]),
         `85-years-and-over` = rowSums(pop_est_raw[,c(90:95)])) %>% 
  select(`0-years`:`85-years-and-over`) %>%
  slice(1:2) %>% 
  summarise(`0-years` = sum(`0-years`),
         `1-14-years` = sum(`1-14-years`),
         `15-44-years` = sum(`15-44-years`),
         `45-64-years` = sum(`45-64-years`),
         `65-74-years` = sum(`65-74-years`),
         `75-84-years` = sum(`75-84-years`),
         `85-years-and-over` = sum(`85-years-and-over`)) %>% 
  pivot_longer(cols = `0-years`:`85-years-and-over`, 
               names_to = "age", 
               values_to = "pop_est_2018") -> pop_est_1
```


```{r, eval=FALSE}
#Save data for report
feather::write_feather(pop_est_1, "derived_data/pop_est_1.feather")
```


```{r}
pop_est_raw %>% 
  mutate(`18-64-years` = rowSums(pop_est_raw[,c(23:69)]),
         `65-74-years` = rowSums(pop_est_raw[,c(70:79)]),
         `75-84-years` = rowSums(pop_est_raw[,c(80:89)]),
         `85-years-and-over` = rowSums(pop_est_raw[,c(90:95)])) %>% 
  select(`18-64-years`:`85-years-and-over`) %>%
  slice(1:2) %>% 
  summarise(`18-64-years` = sum(`18-64-years`),
         `65-74-years` = sum(`65-74-years`),
         `75-84-years` = sum(`75-84-years`),
         `85-years-and-over` = sum(`85-years-and-over`)) %>% 
  pivot_longer(cols = `18-64-years`:`85-years-and-over`, 
               names_to = "age", 
               values_to = "pop_est_2018") -> pop_est_2
feather::write_feather(pop_est_2, "derived_data/pop_est_2.feather")
```



### Care home characteristics


```{r}
ods_dataset("care-homes-demography",
            refPeriod = "2017",
            measureType = "count",
            sex = "all",
            mainClientGroupInCareHome = "all-adults",
            geography = "sc") %>% 
  select(age, value) %>% 
  mutate(value = as.numeric(value)) -> df

df %>% 
  bind_rows(
    df %>% 
      filter(age %in% c("85-94-years", "95-years-and-over")) %>% 
      summarise_if(is.double, sum) %>% 
      mutate(age = "85-years-and-over")
  ) %>% 
  filter(age %nin% c("85-94-years", "95-years-and-over")) -> ch_age_groups

feather::write_feather(ch_age_groups, "derived_data/ch_age_groups.feather")
```


# Plots

## Figure 1

Simple count and % of deaths.

```{r, fig.width=12, fig.height=9}
cv_data_main %>% 
  filter(sex == "all" & location_of_death == "all" & ref_period == "2020",
           cause_of_death == "covid-19-related" & age != "all") %>% 
  group_by(age) %>% 
  summarise(n = sum(value)) %>%
  mutate(pct = round(n/sum(n), 3)) %>% 
  ggplot(aes(age, n)) +
  geom_col(fill = economistt_pal()(1)) +
  geom_text(aes(label = scales::percent(pct, accuracy = 0.1), y = n + 80),
            size = 6) +
  scale_y_continuous(limits = c(0, 2000)) +
  labs(x = "",
       y = "", 
       title = "Deaths Associated with COVID-19 by Age Group",
       subtitle = "16th March 2020 to 25th May 2020",       
       caption = "Source: National Records of Scotland\nDeaths where COVID-19 mentioned on the death certificate") -> fig_1

fig_1
```

```{r, eval=FALSE}
ggsave("plots/20200609_fig_1.png", fig_1, width = 12, height =9, dpi = 300)
```


## Figure 2


```{r, fig.width=12, fig.height=9}
cv_data_main %>% 
  filter(sex == "all" & location_of_death == "all" & cause_of_death == "covid-19-related" &
           ref_period == "2020" & age != "all") %>% 
  group_by(age) %>% 
  summarise(n = sum(value)) %>% 
  left_join(., pop_est_1) %>% 
  mutate(risk = n/pop_est_2018,
         av_risk = sum(n)/sum(pop_est_2018),
         relative_risk = risk/av_risk) %>% 
  ggplot(aes(age, relative_risk)) +
  geom_col(fill = economist_pal()(1)) +
  geom_text(aes(label = round(relative_risk,1), 
                y = relative_risk + 1), size = 6) +
  labs(title = "Risk of dying from COVID-19 relative to Scottish average",
       subtitle = "16th March 2020 to 25th May 2020",
       x = "",
       y = "Relative Risk",
       caption = "Source:National Records of Scotland\nand opendata.nhs.scot (2018 mid-year population estimates)")
```

```{r, eval=FALSE}
ggsave("plots/20200609_fig_2.png", fig_2, width = 12, height =9, dpi = 300)
```


## Figure 3

```{r, fig.width=12, fig.height=9}
ch_age_groups %>%
  left_join(., pop_est_2) %>% 
  mutate(pct = value/pop_est_2018) %>% 
  ggplot(aes(age, pct)) +
  geom_col(fill = economist_pal()(1)) +
  geom_text(aes(label = scales::percent(pct, accuracy = 0.1), y = pct + 0.01),
            size = 6) +
  scale_y_continuous(limits = c(0, 0.2),
                     labels = scales::percent_format(accuracy = 1)) +
  labs(title = "Percentage of Specified Age groups Resident in Care Homes in Scotland",
       subtitle = "2017",
       x = "",
       y = "",
       caption = "Source: Scottish Care Home Census via statistics.gov.scot\nand opendata.nhs.scot (2018 mid-year population estimates)") -> fig_3
fig_3
```


```{r, eval=FALSE}
ggsave("plots/20200609_fig_3.png", fig_3, width = 12, height =9, dpi = 300)
```

## Figure 4

```{r, fig.width=12, fig.height=6}
cv_data_manage %>% 
  filter(variable %in% 
           c("adult-care-homes-proportion-that-have-reported-a-suspected-covid-19-case")) %>%
  mutate(value = as.integer(value)) %>% 
  ggplot(aes(ymd(date), value)) +
  geom_line(colour = economist_pal()(1)) +
  scale_x_date(breaks = scales::pretty_breaks()) +
  scale_y_continuous(labels = scales::percent_format(scale = 1),
                     limits = c(0, 80)) +
  labs(title = "Proportion of care homes reporting suspected COVID-19 cases",
       subtitle = "2020",
       x = "",
       y = "",
       caption = "Source: statistics.gov.scot")
```

## Figure 5

```{r}
other <- cv_data_weekly %>% 
  filter(sex == "all" & age == "all" & cause_of_death == "covid-19-related" &
           location_of_death == "other-institution") %>% 
  summarise(sum = sum(value)) %>% 
  pull(.)

cv_data_weekly %>% 
  filter(sex == "all" & age == "all" & cause_of_death == "covid-19-related" &
           location_of_death %nin% c("all", "other-institution")) %>% 
  ggplot(aes(week_date, value, group = location_of_death, colour = location_of_death)) +
  geom_line(size = 1.4) +
  scale_colour_economist(labels = c("Home/non-institution", "Care Home", "Hospital")) +
  scale_y_continuous(limits = c(0, 400)) +
  scale_x_date(breaks = scales::pretty_breaks(n = 12)) +
  theme(legend.position = "top",
        axis.text.x = element_text(size = 12)) +
  labs(title = "Weekly deaths involving COVID-19 in Scotland by setting",
       x = "Week beginning",
       y = "",
       colour = "",
       caption = glue::glue("Source:NRS Scotland\nExcludes other institutional place of death n = {other}"))
```

## Figure 6


```{r}
cv_data_weekly %>% 
  filter(week_number >13 & sex == "all" & age == "all" & cause_of_death == "covid-19-related" &
           location_of_death %nin% c("other-institution", "all")) %>% 
  group_by(week_date) %>% 
  mutate(pct = round(value/sum(value) * 100, 0)) %>% 
  arrange(week_date, location_of_death) %>% 
  mutate(value = as.double(value),
         label_value = case_when(
           location_of_death == "hospital" ~ value/2,
           location_of_death == "care-home" ~ value/2 + lead(value),
           location_of_death == "-non-institution" & value >22 ~ lead(value, 1) + 
             lead(value, 2) + value/2,
           location_of_death == "-non-institution" & value <=22 ~ lead(value, 1) + 
             lead(value, 2) + (value +20)),
         label_colour = case_when(
           sum(value) < label_value ~ "black",
           sum(value) > label_value ~ "white")) %>% 
  ungroup -> stack_data

stack_data %>% 
  ggplot(aes(week_date, value, fill = location_of_death)) +
  geom_col(position = "stack") +
  geom_text(aes(x = week_date, y = label_value, label = paste0(pct,"%")),
            size = 5, color = stack_data$label_colour) +
  scale_x_date(breaks = scales::pretty_breaks(n = 12)) +
  scale_fill_economist(labels = c("Home/non-institution", "Care Home", "Hospital"),
                       guide = guide_legend(reverse = TRUE)) +
  theme(legend.position = "top") +
  labs(title = "Weekly Deaths from COVID-19",
       subtitle = "by setting",
       x = "Week beginning",
       y = "",
       fill = "",
       caption = glue::glue("Source:NRS Scotland\nExcludes other institutional place of death n = {other}"))
```

## Figure 7

```{r}

```




# Session Info

```{r}
devtools::session_info()
```


